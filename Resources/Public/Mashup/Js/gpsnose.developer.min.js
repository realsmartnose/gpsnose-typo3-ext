var MashupFormTypeEnum,MAX_DATE_TIME_TICKS="3155378975999999999";!function(e){e[e.none=0]="none",e[e.add=1]="add",e[e.edit=2]="edit",e[e.detail=3]="detail",e[e.mashupToken=4]="mashupToken"}(MashupFormTypeEnum||(MashupFormTypeEnum={}));var MashupAdminViewModel=function(){function e(e){var s=this;this.ownMashups=ko.observableArray([]),this.currentMashup=ko.observable(),this.mashupTokenCallbackUrlValue=ko.observable("n/a"),this.mashupTokenCallbackUrlMaxChars=ko.observable(0),this.mashupTokenCallbackUrlIsValid=ko.observable(!1),this.formType=ko.observable(MashupFormTypeEnum.none),this.requestActiveOwnMashups=ko.observable(!1),this.requestActiveRegisterCommunity=ko.observable(!1),this.requestActiveValidateCommunity=ko.observable(!1),this.requestActiveRegenerateAppKey=ko.observable(!1),this.requestActiveUpdateCommunity=ko.observable(!1),this.requestActiveAddSubCommunity=ko.observable(!1),this.requestActiveDelSubCommunity=ko.observable(!1),this.requestActiveMashupToken=ko.observable(!1),this.addMaxCount=ko.observable(0),this.addMaxChars=ko.observable(0),this.privacyDropdownItems=ko.observableArray([]),this.privacyLabel=ko.observable(""),this.privacyIndex=ko.observable(-1),this.registerCommunityValue=ko.observable(""),this.registerCommunityIsValid=ko.observable(!1),this.addSubCommunityValue=ko.observable(""),this.addSubCommunityMaxChars=ko.observable(0),this.addSubCommunityIsValid=ko.observable(!1),this.hosts=ko.observableArray([]),this.addHostValue=ko.observable(""),this.addHostMaxChars=ko.observable(0),this.addHostIsValid=ko.observable(!1),this.createMashupTokenValue=ko.observable(""),this.createMashupTokenMaxChars=ko.observable(0),this.createMashupTokenIsValid=ko.observable(!1),this.createMashupTokenDate=ko.observable(""),this.createMashupTokenSrc=ko.observable(""),this.isAddAllowed=ko.computed(function(){return s.ownMashups().length<s.addMaxCount()}),this.isAddSubCommunityAllowed=ko.computed(function(){return null!=s.currentMashup()&&s.currentMashup().SubCommunities().length<s.currentMashup().MaxSubSites()}),this.isAddHostAllowed=ko.computed(function(){return null!=s.currentMashup()&&s.hosts().length<s.currentMashup().MaxHosts()}),this.onEditMashup=function(e){},this.onDetailMashup=function(e){},this.onMashupToken=function(e){},this.addMaxCount(e.MaxMashups?e.MaxMashups:1),this.addMaxChars(100),this.addSubCommunityMaxChars(20),this.addHostMaxChars(100),this.createMashupTokenMaxChars(200),this.mashupTokenCallbackUrlMaxChars(1e3),this.privacyDropdownItems.push("%"+GetLangRes("Common_lblCommunityPublic","Public")),this.privacyDropdownItems.push("@"+GetLangRes("Common_lblCommunityClosed","Closed")),this.privacyDropdownItems.push("*"+GetLangRes("Common_lblCommunityPrivate","Private")),this.privacyIndex.subscribe(function(e){s.privacyLabel(s.privacyDropdownItems()[e])}),this.privacyIndex(0),this.registerCommunityValue.subscribe(function(e){var t=IsValidDomain(e,s.addMaxChars());s.registerCommunityIsValid(t),s.currentMashup(null)}),this.addSubCommunityValue.subscribe(function(e){var t=IsValidCommunity(e,s.addSubCommunityMaxChars());s.addSubCommunityIsValid(t)}),this.addHostValue.subscribe(function(e){var t=IsValidDomain(e,s.addHostMaxChars());s.addHostIsValid(t)}),this.createMashupTokenValue.subscribe(function(e){var t=0<e.length&&e.length<=s.createMashupTokenMaxChars();s.createMashupTokenIsValid(t),s.createMashupTokenSrc("")}),this.createMashupTokenDate.subscribe(function(e){s.createMashupTokenSrc("")}),this.mashupTokenCallbackUrlValue.subscribe(function(e){var t=s.currentMashup()?s.currentMashup().CommunityTagSufix():null,a=0==e.length||IsValidUrl(e,s.mashupTokenCallbackUrlMaxChars(),t);s.mashupTokenCallbackUrlIsValid(a)})}return e.prototype.EditMashup=function(e){this.currentMashup(e),this.formType(MashupFormTypeEnum.edit),this.mashupTokenCallbackUrlValue(e.MashupTokenCallbackUrl()),this.addHostValue(""),this.hosts(e.Hosts().slice(0)),this.onEditMashup&&this.onEditMashup(e)},e.prototype.DetailMashup=function(e){this.currentMashup(e),this.formType(MashupFormTypeEnum.detail),this.onDetailMashup&&this.onDetailMashup(e)},e.prototype.MashupToken=function(e){this.currentMashup(e),this.formType(MashupFormTypeEnum.mashupToken),this.onMashupToken&&this.onMashupToken(e)},e.prototype.GetCommunityNameFromAdd=function(e){return this.GetCommunityPrefix(this.privacyDropdownItems()[this.privacyIndex()])+e},e.prototype.GetCommunityHtml=function(e,t){var a="";switch(this.GetCommunityPrefix(e)){case"@":a="lock";break;case"*":a="eye-close";break;case"%":a="globe"}return t=t?" "+t:"",""!=a&&e&&2<e.length?'<span class="glyphicon glyphicon-'+a+'"></span><span class="keyword-label'+t+'"> '+e.substr(1,e.length)+"</span>":'<span class="glyphicon glyphicon-globe"></span><span class="keyword-label'+t+'"> '+e+"</span>"},e.prototype.GetCommunityPrefix=function(e){return!e||e.length<1?"%":e.charAt(0)},e.prototype.GetOwnMashups=function(){var a=this;a.requestActiveOwnMashups()||(a.requestActiveOwnMashups(!0),$.ajax({type:"POST",url:"/MashupAdmin/GetOwnMashups",cache:!1,data:{},dataType:"json",success:function(e){a.requestActiveOwnMashups(!1),0<e.ErrorCode?dialog.show(GetLangRes("Common_lblError","Error"),e.Message,null):ko.utils.arrayForEach(e,function(e,t){a.ownMashups.push(new MashupDto(e))})},error:function(){a.requestActiveOwnMashups(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}}))},e.prototype.RegisterCommunity=function(){var a=this;if(!a.requestActiveRegisterCommunity()){a.currentMashup(null);var t=this.GetCommunityNameFromAdd(this.registerCommunityValue()),s=!0;ko.utils.arrayForEach(a.ownMashups(),function(e,t){e.CommunityTagSufix()==a.registerCommunityValue()&&(s=!1)}),s?(a.requestActiveRegisterCommunity(!0),$.ajax({type:"POST",url:"/MashupAdmin/RegisterCommunityWeb",cache:!1,data:{tag:t},dataType:"json",success:function(e){a.requestActiveRegisterCommunity(!1),0<e.ErrorCode?dialog.show(GetLangRes("Common_lblError","Error"),e.Message,null):a.currentMashup(new MashupDto({CommunityTag:t,ValidationKey:e.ValidationKey}))},error:function(){a.requestActiveRegisterCommunity(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})):dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblDuplicateItem","There is already an entry with the same name!"),null)}},e.prototype.ValidateCommunity=function(){var a=this;if(!a.requestActiveValidateCommunity()){var e=this.GetCommunityNameFromAdd(this.registerCommunityValue());a.requestActiveValidateCommunity(!0),$.ajax({type:"POST",url:"/MashupAdmin/ValidateCommunityWeb",cache:!1,data:{tag:e},dataType:"json",success:function(e){if(a.requestActiveValidateCommunity(!1),0<e.ErrorCode)dialog.show(GetLangRes("Common_lblError","Error"),e.Message,null);else{var t=a.currentMashup();null!=t&&(t.AppKey(e.AppKey),t.ValidationTicks(GetTicksFromDate(new Date)),a.ownMashups.push(t)),a.formType(MashupFormTypeEnum.none),a.registerCommunityValue(""),a.currentMashup(null)}},error:function(){a.requestActiveValidateCommunity(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})}},e.prototype.AddHost=function(){if(null!=this.currentMashup())if(this.hosts().indexOf(this.addHostValue())<0){var e=this.hosts().slice(0);e.push(this.addHostValue()),this.hosts(e),this.addHostValue("")}else dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblDuplicateItem","There is already an entry with the same name!"),null)},e.prototype.RemoveHost=function(e){if(null!=this.currentMashup()){var t=this.hosts().slice(0);t.splice(t.indexOf(e),1),this.hosts(t)}},e.prototype.UpdateCommunity=function(){if(null!=this.currentMashup()){var t=this;if(t.requestActiveUpdateCommunity())return;t.requestActiveUpdateCommunity(!0),$.ajax({type:"POST",url:"/MashupAdmin/UpdateCommunityWeb",cache:!1,data:{tag:t.currentMashup().CommunityTag(),hosts:this.hosts().slice(0),mashupTokenCallbackUrl:t.mashupTokenCallbackUrlValue()},dataType:"json",success:function(e){t.requestActiveUpdateCommunity(!1),t.currentMashup()&&(t.currentMashup().Hosts([]),t.currentMashup().Hosts(t.hosts().slice(0)),t.currentMashup().MashupTokenCallbackUrl(t.mashupTokenCallbackUrlValue())),t.addHostValue("")},error:function(){t.requestActiveUpdateCommunity(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})}},e.prototype.RegenerateAppKey=function(){var a=this;null!=this.currentMashup()&&dialog.show(GetLangRes("Common_lblAreYouSureTitle","Are you sure?"),GetLangRes("Common_lblAreYouSureMessage","This can not be undone, proceed anyway?"),function(){dialog.hide();var t=a;if(!t.requestActiveRegenerateAppKey()){var e=t.currentMashup().CommunityTag();t.requestActiveRegenerateAppKey(!0),$.ajax({type:"POST",url:"/MashupAdmin/RegenerateAppKey",cache:!1,data:{tag:e},dataType:"json",success:function(e){t.requestActiveRegenerateAppKey(!1),0<e.ErrorCode?dialog.show(GetLangRes("Common_lblError","Error"),e.Message,null):t.currentMashup()&&t.currentMashup().AppKey(e.AppKey)},error:function(){t.requestActiveRegenerateAppKey(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})}})},e.prototype.AddSubCommunity=function(){if(null!=this.currentMashup()){var a=this;if(a.requestActiveAddSubCommunity())return;var s=a.GetCommunityNameFromAdd(a.currentMashup().CommunityTagSufix())+"@"+a.addSubCommunityValue();a.currentMashup().SubCommunities().indexOf(s)<0?(a.requestActiveAddSubCommunity(!0),$.ajax({type:"POST",url:"/MashupAdmin/AddSubCommunity",cache:!1,data:{tag:s},dataType:"json",success:function(e){if(a.requestActiveAddSubCommunity(!1),0<e.ErrorCode)dialog.show(GetLangRes("Common_lblError","Error"),e.Message,null);else{var t=a.currentMashup().SubCommunities().slice(0);t.push(s),a.currentMashup().SubCommunities([]),a.currentMashup().SubCommunities(t),a.addSubCommunityValue("")}},error:function(){a.requestActiveAddSubCommunity(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})):dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblDuplicateItem","There is already an entry with the same name!"),null)}},e.prototype.DelSubCommunity=function(s){var e=this;dialog.show(GetLangRes("Common_lblAreYouSureTitle","Are you sure?"),GetLangRes("Common_lblAreYouSureMessage","This can not be undone, proceed anyway?"),function(){dialog.hide();var a=e;a.requestActiveDelSubCommunity()||(a.requestActiveDelSubCommunity(!0),$.ajax({type:"POST",url:"/MashupAdmin/DelSubCommunity",cache:!1,data:{tag:s},dataType:"json",success:function(e){if(a.requestActiveDelSubCommunity(!1),0<e.ErrorCode)dialog.show(GetLangRes("Common_lblError","Error"),e.Message,null);else{var t=a.currentMashup().SubCommunities().slice(0);t.splice(t.indexOf(s),1),a.currentMashup().SubCommunities([]),a.currentMashup().SubCommunities(t),a.addSubCommunityValue("")}},error:function(){a.requestActiveDelSubCommunity(!1),dialog.show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}}))})},e.prototype.CreateMashupToken=function(){var e=this;if(e.createMashupTokenIsValid()&&null!=e.currentMashup()){if(e.requestActiveMashupToken())return;e.requestActiveMashupToken(!0);var t=null;""!=e.createMashupTokenDate()&&(t=GetTicksFromDate(moment.utc(e.createMashupTokenDate()).add(1,"d").toDate()));var a="/MashupApi/GenerateQrTokenForMashup?appKey="+e.currentMashup().AppKey()+"&tag="+encodeURI(e.currentMashup().CommunityTag())+"&payload="+encodeURI(e.createMashupTokenValue())+(null!=t?"&validToTicks="+t:""),s=new Image;s.onload=function(){e.createMashupTokenSrc(a),e.requestActiveMashupToken(!1)},s.src=a}else e.createMashupTokenSrc("")},e}(),MashupDto=function(){function e(e){this.CommunityTag=ko.observable(""),this.ValidationKey=ko.observable(""),this.AppKey=ko.observable(""),this.ValidationTicks=ko.observable("0"),this.Hosts=ko.observableArray([]),this.SubCommunities=ko.observableArray([]),this.History=ko.observableArray([]),this.MaxSubSites=ko.observable(0),this.MaxHosts=ko.observable(0),this.MaxCallsDaily=ko.observable(0),this.MaxCallsMonthly=ko.observable(0),this.MashupTokenCallbackUrl=ko.observable(""),this.CommunityTag(e.CommunityTag),this.ValidationKey(e.ValidationKey),this.AppKey(e.AppKey),this.ValidationTicks(e.ValidationTicks),this.MaxSubSites(e.MaxSubSites?e.MaxSubSites:3),this.MaxHosts(e.MaxHosts?e.MaxHosts:3),this.MaxCallsDaily(e.MaxCallsDaily?e.MaxCallsDaily:500),this.MaxCallsMonthly(e.MaxCallsMonthly?e.MaxCallsMonthly:5e3),this.MashupTokenCallbackUrl(e.MashupTokenCallbackUrl?e.MashupTokenCallbackUrl:"");var a=this;if(e.Hosts&&ko.utils.arrayForEach(e.Hosts,function(e,t){a.Hosts.push(e)}),e.SubCommunities&&ko.utils.arrayForEach(e.SubCommunities,function(e,t){a.SubCommunities.push(e)}),e.CallHistory)for(var t in e.CallHistory){var s=e.ExceededQuotaHistory[t];a.History.push(new HistoryDto(t,e.CallHistory[t],0<s?s:0))}if(e.ExceededQuotaHistory)for(var t in e.ExceededQuotaHistory)null==e.CallHistory[t]&&a.History.push(new HistoryDto(t,0,e.ExceededQuotaHistory[t]))}return e.prototype.CommunityTagPrefix=function(){return this.CommunityTag().substring(0,1)},e.prototype.CommunityTagSufix=function(){return this.CommunityTag().substring(1,this.CommunityTag().length)},e}(),HistoryDto=function(e,t,a){this.Ticks=e,this.Call=t,this.ExQuota=a};