var MashupFormTypeEnum,__extends=this&&this.__extends||function(){var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)};return function(e,t){function s(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}(),BaseNavigableItem=function(e){e&&jQuery.extend(this,e),!this.LoginName&&e.Creator&&(this.LoginName=e.Creator),this.UniqueKey?(this.LoginName=GetLoginNameFromUniqueKey(this.UniqueKey),this.CreationTicks=GetTicksFromUniqueKey(this.UniqueKey)):this.CreationTicks&&(this.UniqueKey=GetUniqueKey(this.LoginName,this.CreationTicks))},NoseDto=function(s){function e(e){var t=s.call(this,e)||this;return t.IsInCommunity=function(e){return t.Communities&&-1!=jQuery.inArray(e,t.Communities)},t.ThumbSize="@200",t.ImageUrl=function(){return gnSettings.BaseDataUrl+"/profimg/"+encodeURIComponent(t.LoginName)},t.PreviewUrl=function(){return"/nose/preview/"+encodeURIComponent(t.LoginName)},t.DetailUrl=function(){return(MA_GPSNOSE_IS_MASHUP?gnSettings.BaseUrl:"")+"/"+encodeURIComponent(t.LoginName)+(MA_GPSNOSE_IS_MASHUP&&gnSettings.LoginId?"?lid="+gnSettings.LoginId:"")},t.ShareUrl=function(){return gnSettings.BaseUrl+"/"+encodeURIComponent(t.LoginName)},t}return __extends(e,s),e}(BaseNavigableItem),MAX_DATE_TIME_TICKS="3155378975999999999";!function(e){e[e.None=0]="None",e[e.Add=1]="Add",e[e.Edit=2]="Edit",e[e.Detail=3]="Detail",e[e.MashupToken=4]="MashupToken"}(MashupFormTypeEnum||(MashupFormTypeEnum={}));var MashupAdminViewModel=function(){function e(e){var a=this;this.OwnMashups=ko.observableArray([]),this.CurrentMashup=ko.observable(),this.MashupTokenCallbackUrlValue=ko.observable("n/a"),this.MashupTokenCallbackUrlMaxChars=ko.observable(0),this.MashupTokenCallbackUrlIsValid=ko.observable(!1),this.FormType=ko.observable(MashupFormTypeEnum.None),this.RequestActiveOwnMashups=ko.observable(!1),this.RequestActiveRegisterCommunity=ko.observable(!1),this.RequestActiveValidateCommunity=ko.observable(!1),this.RequestActiveRegenerateAppKey=ko.observable(!1),this.RequestActiveUpdateCommunity=ko.observable(!1),this.RequestActiveAddSubCommunity=ko.observable(!1),this.RequestActiveDelSubCommunity=ko.observable(!1),this.RequestActiveMashupTokenNew=ko.observable(!1),this.AddMaxCount=ko.observable(0),this.AddMaxChars=ko.observable(0),this.PrivacyDropdownItems=ko.observableArray([]),this.PrivacyLabel=ko.observable(""),this.PrivacyIndex=ko.observable(-1),this.RegisterCommunityValue=ko.observable(""),this.RegisterCommunityIsValid=ko.observable(!1),this.AddSubCommunityValue=ko.observable(""),this.AddSubCommunityMaxChars=ko.observable(0),this.AddSubCommunityIsValid=ko.observable(!1),this.Hosts=ko.observableArray([]),this.AddHostValue=ko.observable(""),this.AddHostMaxChars=ko.observable(0),this.AddHostIsValid=ko.observable(!1),this.CreateMashupTokenValue=ko.observable(""),this.CreateMashupTokenMaxChars=ko.observable(0),this.CreateMashupTokenIsValid=ko.observable(!1),this.CreateMashupTokenDate=ko.observable(""),this.CreateMashupTokenSrc=ko.observable(""),this.MashupTokenPageUrl="/MashupApi/GetMashupTokensPage",this.MashupTokens=ko.observableArray([]),this.MashupTokensPageSize=gnSettings.MashupTokensPageSize,this.MashupTokensLastKnownTicks="0",this.HasMoreMashupTokens=ko.observable(!0),this.MashupTokensRequestActive=ko.observable(!1),this.IsAddAllowed=ko.computed(function(){return a.OwnMashups().length<a.AddMaxCount()}),this.IsAddSubCommunityAllowed=ko.computed(function(){return null!=a.CurrentMashup()&&a.CurrentMashup().SubCommunities().length<a.CurrentMashup().MaxSubSites()}),this.IsAddHostAllowed=ko.computed(function(){return null!=a.CurrentMashup()&&a.Hosts().length<a.CurrentMashup().MaxHosts()}),this.AddMaxCount(e.MaxMashups?e.MaxMashups:1),this.AddMaxChars(100),this.AddSubCommunityMaxChars(20),this.AddHostMaxChars(100),this.CreateMashupTokenMaxChars(200),this.MashupTokenCallbackUrlMaxChars(1e3),this.PrivacyDropdownItems.push("%"+GetLangRes("Common_lblCommunityPublic","Public")),this.PrivacyDropdownItems.push("@"+GetLangRes("Common_lblCommunityClosed","Closed")),this.PrivacyDropdownItems.push("*"+GetLangRes("Common_lblCommunityPrivate","Private")),this.PrivacyIndex.subscribe(function(e){a.PrivacyLabel(a.PrivacyDropdownItems()[e])}),this.PrivacyIndex(0),this.RegisterCommunityValue.subscribe(function(e){var t=IsValidDomain(e,a.AddMaxChars());a.RegisterCommunityIsValid(t),a.CurrentMashup(null)}),this.AddSubCommunityValue.subscribe(function(e){var t=IsValidCommunity(e,a.AddSubCommunityMaxChars());a.AddSubCommunityIsValid(t)}),this.AddHostValue.subscribe(function(e){var t=IsValidDomain(e,a.AddHostMaxChars());a.AddHostIsValid(t)}),this.CreateMashupTokenValue.subscribe(function(e){var t=0<e.length&&e.length<=a.CreateMashupTokenMaxChars();a.CreateMashupTokenIsValid(t),a.CreateMashupTokenSrc("")}),this.CreateMashupTokenDate.subscribe(function(e){a.CreateMashupTokenSrc("")}),this.MashupTokenCallbackUrlValue.subscribe(function(e){var t=a.CurrentMashup()?a.CurrentMashup().CommunityTagSufix():null,s=0==e.length||IsValidUrl(e,a.MashupTokenCallbackUrlMaxChars(),t);a.MashupTokenCallbackUrlIsValid(s)})}return e.prototype.OnAddMashupTokens=function(){},e.prototype.AddMashupTokens=function(e){if(null!=e){if(0<e.length){for(var t in e){var s=new MashupTokenDto(e[t]);s.ScannedTicks()>this.MashupTokensLastKnownTicks&&(this.MashupTokensLastKnownTicks=s.ScannedTicks()),this.MashupTokens.push(s)}e.length%this.MashupTokensPageSize!=0&&this.HasMoreMashupTokens(!1)}else this.HasMoreMashupTokens(!1);this.OnAddMashupTokens&&this.OnAddMashupTokens()}},e.prototype.PageMashupTokens=function(){var t=this;this.MashupTokensRequestActive()||(this.MashupTokensRequestActive(!0),jQuery.ajax({type:"POST",url:this.MashupTokenPageUrl,cache:!1,data:{appKey:this.CurrentMashup().AppKey(),lastKnownScanTicks:this.MashupTokensLastKnownTicks,pageSize:this.MashupTokensPageSize},dataType:"json",success:function(e){e&&0<e.length?t.AddMashupTokens(e):t.HasMoreMashupTokens(!1),t.MashupTokensRequestActive(!1)},error:function(e){429!=e.status&&dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorCannotPage","Page cannot be loaded!"),null),t.MashupTokensRequestActive(!1)}}))},e.prototype.OnEditMashup=function(e){},e.prototype.EditMashup=function(e){this.CurrentMashup(e),this.FormType(MashupFormTypeEnum.Edit),this.MashupTokenCallbackUrlValue(e.MashupTokenCallbackUrl()),this.AddHostValue(""),this.Hosts(e.Hosts().slice(0)),this.OnEditMashup&&this.OnEditMashup(e)},e.prototype.OnDetailMashup=function(e){},e.prototype.DetailMashup=function(e){this.CurrentMashup(e),this.FormType(MashupFormTypeEnum.Detail),this.OnDetailMashup&&this.OnDetailMashup(e)},e.prototype.OnMashupToken=function(e){},e.prototype.MashupToken=function(e){this.CurrentMashup(e),this.FormType(MashupFormTypeEnum.MashupToken),this.OnMashupToken&&this.OnMashupToken(e)},e.prototype.GetCommunityNameFromAdd=function(e){return this.GetCommunityPrefix(this.PrivacyDropdownItems()[this.PrivacyIndex()])+e},e.prototype.GetCommunityHtml=function(e,t){var s="";switch(this.GetCommunityPrefix(e)){case"@":s="lock";break;case"*":s="eye-close";break;case"%":s="globe"}return t=t?" "+t:"",""!=s&&e&&2<e.length?'<span class="glyphicon glyphicon-'+s+'"></span><span class="keyword-label'+t+'"> '+e.substr(1,e.length)+"</span>":'<span class="glyphicon glyphicon-globe"></span><span class="keyword-label'+t+'"> '+e+"</span>"},e.prototype.GetCommunityPrefix=function(e){return!e||e.length<1?"%":e.charAt(0)},e.prototype.GetOwnMashups=function(){var s=this;s.RequestActiveOwnMashups()||(s.RequestActiveOwnMashups(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/GetOwnMashups",cache:!1,data:{},dataType:"json",success:function(e){s.RequestActiveOwnMashups(!1),0<e.ErrorCode?dialog.Show(GetLangRes("Common_lblError","Error"),e.Message,null):ko.utils.arrayForEach(e,function(e,t){s.OwnMashups.push(new MashupDto(e))})},error:function(){s.RequestActiveOwnMashups(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}}))},e.prototype.RegisterCommunity=function(){var s=this;if(!s.RequestActiveRegisterCommunity()){s.CurrentMashup(null);var t=this.GetCommunityNameFromAdd(this.RegisterCommunityValue()),a=!0;ko.utils.arrayForEach(s.OwnMashups(),function(e,t){e.CommunityTagSufix()==s.RegisterCommunityValue()&&(a=!1)}),a?(s.RequestActiveRegisterCommunity(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/RegisterCommunityWeb",cache:!1,data:{tag:t},dataType:"json",success:function(e){s.RequestActiveRegisterCommunity(!1),0<e.ErrorCode?dialog.Show(GetLangRes("Common_lblError","Error"),e.Message,null):s.CurrentMashup(new MashupDto({CommunityTag:t,ValidationKey:e.ValidationKey}))},error:function(){s.RequestActiveRegisterCommunity(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})):dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblDuplicateItem","There is already an entry with the same name!"),null)}},e.prototype.ValidateCommunity=function(){var s=this;if(!s.RequestActiveValidateCommunity()){var e=this.GetCommunityNameFromAdd(this.RegisterCommunityValue());s.RequestActiveValidateCommunity(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/ValidateCommunityWeb",cache:!1,data:{tag:e},dataType:"json",success:function(e){if(s.RequestActiveValidateCommunity(!1),0<e.ErrorCode)dialog.Show(GetLangRes("Common_lblError","Error"),e.Message,null);else{var t=s.CurrentMashup();null!=t&&(t.AppKey(e.AppKey),t.ValidationTicks(GetTicksFromDate(new Date)),s.OwnMashups.push(t)),s.FormType(MashupFormTypeEnum.None),s.RegisterCommunityValue(""),s.CurrentMashup(null)}},error:function(){s.RequestActiveValidateCommunity(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})}},e.prototype.AddHost=function(){if(null!=this.CurrentMashup())if(this.Hosts().indexOf(this.AddHostValue())<0){var e=this.Hosts().slice(0);e.push(this.AddHostValue()),this.Hosts(e),this.AddHostValue("")}else dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblDuplicateItem","There is already an entry with the same name!"),null)},e.prototype.RemoveHost=function(e){if(null!=this.CurrentMashup()){var t=this.Hosts().slice(0);t.splice(t.indexOf(e),1),this.Hosts(t)}},e.prototype.UpdateCommunity=function(){if(null!=this.CurrentMashup()){var t=this;if(t.RequestActiveUpdateCommunity())return;t.RequestActiveUpdateCommunity(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/UpdateCommunityWeb",cache:!1,data:{tag:t.CurrentMashup().CommunityTag(),hosts:this.Hosts().slice(0),mashupTokenCallbackUrl:t.MashupTokenCallbackUrlValue()},dataType:"json",success:function(e){t.RequestActiveUpdateCommunity(!1),t.CurrentMashup()&&(t.CurrentMashup().Hosts([]),t.CurrentMashup().Hosts(t.Hosts().slice(0)),t.CurrentMashup().MashupTokenCallbackUrl(t.MashupTokenCallbackUrlValue())),t.AddHostValue("")},error:function(){t.RequestActiveUpdateCommunity(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})}},e.prototype.RegenerateAppKey=function(){var s=this;null!=this.CurrentMashup()&&dialog.Show(GetLangRes("Common_lblAreYouSureTitle","Are you sure?"),GetLangRes("Common_lblAreYouSureMessage","This can not be undone, proceed anyway?"),function(){dialog.Hide();var t=s;if(!t.RequestActiveRegenerateAppKey()){var e=t.CurrentMashup().CommunityTag();t.RequestActiveRegenerateAppKey(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/RegenerateAppKey",cache:!1,data:{tag:e},dataType:"json",success:function(e){t.RequestActiveRegenerateAppKey(!1),0<e.ErrorCode?dialog.Show(GetLangRes("Common_lblError","Error"),e.Message,null):t.CurrentMashup()&&t.CurrentMashup().AppKey(e.AppKey)},error:function(){t.RequestActiveRegenerateAppKey(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})}})},e.prototype.AddSubCommunity=function(){if(null!=this.CurrentMashup()){var s=this;if(s.RequestActiveAddSubCommunity())return;var a=s.GetCommunityNameFromAdd(s.CurrentMashup().CommunityTagSufix())+"@"+s.AddSubCommunityValue();s.CurrentMashup().SubCommunities().indexOf(a)<0?(s.RequestActiveAddSubCommunity(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/AddSubCommunity",cache:!1,data:{tag:a},dataType:"json",success:function(e){if(s.RequestActiveAddSubCommunity(!1),0<e.ErrorCode)dialog.Show(GetLangRes("Common_lblError","Error"),e.Message,null);else{var t=s.CurrentMashup().SubCommunities().slice(0);t.push(a),s.CurrentMashup().SubCommunities([]),s.CurrentMashup().SubCommunities(t),s.AddSubCommunityValue("")}},error:function(){s.RequestActiveAddSubCommunity(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}})):dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblDuplicateItem","There is already an entry with the same name!"),null)}},e.prototype.DelSubCommunity=function(a){var e=this;dialog.Show(GetLangRes("Common_lblAreYouSureTitle","Are you sure?"),GetLangRes("Common_lblAreYouSureMessage","This can not be undone, proceed anyway?"),function(){dialog.Hide();var s=e;s.RequestActiveDelSubCommunity()||(s.RequestActiveDelSubCommunity(!0),jQuery.ajax({type:"POST",url:"/MashupAdmin/DelSubCommunity",cache:!1,data:{tag:a},dataType:"json",success:function(e){if(s.RequestActiveDelSubCommunity(!1),0<e.ErrorCode)dialog.Show(GetLangRes("Common_lblError","Error"),e.Message,null);else{var t=s.CurrentMashup().SubCommunities().slice(0);t.splice(t.indexOf(a),1),s.CurrentMashup().SubCommunities([]),s.CurrentMashup().SubCommunities(t),s.AddSubCommunityValue("")}},error:function(){s.RequestActiveDelSubCommunity(!1),dialog.Show(GetLangRes("Common_lblError","Error"),GetLangRes("Common_lblErrorContentUnavailable","The requested content cannot be loaded. <br/> Please try again later."),null)}}))})},e.prototype.CreateMashupToken=function(){var e=this;if(e.CreateMashupTokenIsValid()&&null!=e.CurrentMashup()){if(e.RequestActiveMashupTokenNew())return;e.RequestActiveMashupTokenNew(!0);var t=null;""!=e.CreateMashupTokenDate()&&(t=GetTicksFromDate(moment.utc(e.CreateMashupTokenDate()).add(1,"d").toDate()));var s="/MashupApi/GenerateQrTokenForMashup?appKey="+e.CurrentMashup().AppKey()+"&tag="+encodeURI(e.CurrentMashup().CommunityTag())+"&payload="+encodeURI(e.CreateMashupTokenValue())+(null!=t?"&validToTicks="+t:""),a=new Image;a.onload=function(){e.CreateMashupTokenSrc(s),e.RequestActiveMashupTokenNew(!1)},a.src=s}else e.CreateMashupTokenSrc("")},e}(),MashupDto=function(){function e(e){this.CommunityTag=ko.observable(""),this.ValidationKey=ko.observable(""),this.AppKey=ko.observable(""),this.ValidationTicks=ko.observable("0"),this.Hosts=ko.observableArray([]),this.SubCommunities=ko.observableArray([]),this.History=ko.observableArray([]),this.MaxSubSites=ko.observable(0),this.MaxHosts=ko.observable(0),this.MaxCallsDaily=ko.observable(0),this.MaxCallsMonthly=ko.observable(0),this.MashupTokenCallbackUrl=ko.observable(""),this.CommunityTag(e.CommunityTag),this.ValidationKey(e.ValidationKey),this.AppKey(e.AppKey),this.ValidationTicks(e.ValidationTicks),this.MaxSubSites(e.MaxSubSites?e.MaxSubSites:3),this.MaxHosts(e.MaxHosts?e.MaxHosts:3),this.MaxCallsDaily(e.MaxCallsDaily?e.MaxCallsDaily:500),this.MaxCallsMonthly(e.MaxCallsMonthly?e.MaxCallsMonthly:5e3),this.MashupTokenCallbackUrl(e.MashupTokenCallbackUrl?e.MashupTokenCallbackUrl:"");var s=this;if(e.Hosts&&ko.utils.arrayForEach(e.Hosts,function(e,t){s.Hosts.push(e)}),e.SubCommunities&&ko.utils.arrayForEach(e.SubCommunities,function(e,t){s.SubCommunities.push(e)}),e.CallHistory)for(var t in e.CallHistory){var a=e.ExceededQuotaHistory[t];s.History.push(new HistoryDto(t,e.CallHistory[t],0<a?a:0))}if(e.ExceededQuotaHistory)for(var t in e.ExceededQuotaHistory)null==e.CallHistory[t]&&s.History.push(new HistoryDto(t,0,e.ExceededQuotaHistory[t]))}return e.prototype.CommunityTagPrefix=function(){return this.CommunityTag().substring(0,1)},e.prototype.CommunityTagSufix=function(){return this.CommunityTag().substring(1,this.CommunityTag().length)},e}(),HistoryDto=function(e,t,s){this.Ticks=e,this.Call=t,this.ExQuota=s},MashupTokenDto=function(e){this.NoseDto=ko.observable(),this.Payload=ko.observable(""),this.ScannedByLoginName=ko.observable(""),this.ScannedLatitude=ko.observable(0),this.ScannedLongitude=ko.observable(0),this.ScannedTicks=ko.observable("0"),this.RecordedTicks=ko.observable("0"),this.CallbackResponseHttpCode=ko.observable(0),this.CallbackResponseMessage=ko.observable(""),this.Payload(e.Payload),this.ScannedByLoginName(e.ScannedByLoginName),this.ScannedLatitude(e.ScannedLatitude),this.ScannedLongitude(e.ScannedLongitude),this.ScannedTicks(e.ScannedTicks),this.RecordedTicks(e.RecordedTicks),this.CallbackResponseHttpCode(e.CallbackResponseHttpCode),this.CallbackResponseMessage(e.CallbackResponseMessage),this.NoseDto(new NoseDto({LoginName:this.ScannedByLoginName()}))};